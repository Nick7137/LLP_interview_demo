<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Bank Transaction Details</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Roboto', sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f4f7f9; 
        }

        header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            margin: 0;
            font-size: 24px;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .card { 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 20px; 
            margin-top: 20px; 
            overflow: hidden;
        }

        .items { margin-top: 20px; }
        .item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed #eee; }
        .item:last-child { border-bottom: none; }

        .total { 
            margin-top: 20px; 
            font-weight: bold; 
            font-size: 18px; 
        }
        
        .btn {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 15px;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            font-size: 16px;
            cursor: pointer;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #777;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Transaction Details</h1>
    </header>
    <div class="container">
        <div id="transaction" class="card" style="display:none;"></div>
        <div class="footer">© 2024 Bank Name. All rights reserved.</div>
    </div>
    
    <script>
        // Fetch and display transaction data
        async function displayTransaction() {
            const urlParams = new URLSearchParams(window.location.search);
            const txnId = urlParams.get('txn'); // Transaction number from receipt input
            const transactionUrl = urlParams.get('data'); // Legacy support for direct URL
            
            let tx = null;

            // Try to get transaction from localStorage first (from NFC tap)
            if (txnId) {
                try {
                    const transactions = JSON.parse(localStorage.getItem('transactions') || '{}');
                    // Try direct lookup first
                    tx = transactions[txnId];
                    
                    // If not found, search by receipt number or transaction ID
                    if (!tx) {
                        for (const key in transactions) {
                            const t = transactions[key];
                            if (t.receiptNumber === txnId || t.id === txnId) {
                                tx = t;
                                break;
                            }
                        }
                    }
                    
                    // If still not found in localStorage, try to fetch from a transactions API or file
                    if (!tx) {
                        // Try to load from a transactions data file
                        try {
                            const response = await fetch(`transactions/${txnId}.json`);
                            if (response.ok) {
                                tx = await response.json();
                            }
                        } catch (e) {
                            console.log('Transaction not found in file system');
                        }
                    }
                } catch (e) {
                    console.error('Error reading from localStorage:', e);
                }
            }

            // Legacy support: fetch from URL
            if (!tx && transactionUrl) {
                try {
                    const res = await fetch(transactionUrl);
                    tx = await res.json();
                } catch (e) {
                    console.error('Fetch error:', e);
                }
            }

            // Fallback: use default transaction data
            if (!tx) {
                try {
                    const res = await fetch('tx.json');
                    tx = await res.json();
                } catch (e) {
                    console.error('Error loading default transaction:', e);
                    tx = {
                        merchantName: 'Unknown Merchant',
                        timestamp: new Date().toISOString(),
                        currency: 'USD',
                        totalAmount: 0,
                        taxAmount: 0,
                        items: []
                    };
                }
            }

            if (tx) {
                const txEl = document.getElementById('transaction');
                txEl.style.display = 'block';
                
                const transactionDate = tx.timestamp ? new Date(tx.timestamp).toLocaleString() : new Date().toLocaleString();
                const currency = tx.currency || 'USD';
                
                txEl.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <strong>Receipt Number:</strong> ${tx.receiptNumber || txnId || 'N/A'}<br>
                        <strong>Transaction ID:</strong> ${tx.id || txnId || 'N/A'}<br>
                        <strong>Merchant:</strong> ${tx.merchantName || 'Unknown'}<br>
                        <strong>Date:</strong> ${transactionDate}<br>
                        <strong>Currency:</strong> ${currency}<br>
                    </div>
                    <div class="items">
                        <strong style="display: block; margin-bottom: 12px; font-size: 16px;">Itemized Receipt</strong>
                        ${Array.isArray(tx.items) && tx.items.length > 0 ? tx.items.map(i => {
                            const qty = i.qty || 1;
                            const unitPrice = i.unitPrice || 0;
                            const lineTotal = i.lineTotal ?? (unitPrice * qty);
                            return `
                                <div class="item">
                                    <span>${qty} × ${i.name || 'Item'}</span>
                                    <span>${currency === 'USD' ? '$' : ''}${Number(lineTotal).toFixed(2)}</span>
                                </div>
                            `;
                        }).join('') : '<div class="item"><span>No items found</span></div>'}
                    </div>
                    <div class="total" style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #ddd;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Subtotal:</span>
                            <span>${currency === 'USD' ? '$' : ''}${(Number(tx.totalAmount ?? 0) - Number(tx.taxAmount ?? 0)).toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Tax:</span>
                            <span>${currency === 'USD' ? '$' : ''}${(Number(tx.taxAmount ?? 0)).toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: bold;">
                            <span>Total:</span>
                            <span>${currency === 'USD' ? '$' : ''}${(Number(tx.totalAmount ?? 0)).toFixed(2)}</span>
                        </div>
                    </div>
                `;
            } else {
                const txEl = document.getElementById('transaction');
                txEl.style.display = 'block';
                txEl.innerHTML = `
                    <div style="color: #dc3545; padding: 20px; text-align: center;">
                        <strong>Transaction Not Found</strong><br>
                        <p style="margin-top: 10px;">The receipt number "${txnId || 'N/A'}" could not be found in our records.</p>
                        <p style="margin-top: 10px; font-size: 14px;">Please verify the receipt number and try again.</p>
                    </div>
                `;
            }
        }
        displayTransaction();
    </script>
</body>
</html>
