<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Bank Itemized Transaction Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: system-ui, sans-serif; margin: 20px; }
        #status { margin-bottom: 12px; color: #555; }
        .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-top: 12px; }
        .items { margin-top: 8px; }
        .item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #eee; }
        .item:last-child { border-bottom: none; }
        button { padding: 10px 14px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>Bank Portal — Itemized Transaction</h1>
    <p id="status">Ready. Tap “Scan NFC” and bring a tag near the phone.</p>
    <button id="scanBtn">Scan NFC</button>
    <div id="transaction" class="card" style="display:none;"></div>
  
    <script>
        async function startScan() {
            const statusEl = document.getElementById('status');
            const txEl = document.getElementById('transaction');

            if (!('NDEFReader' in window)) {
                statusEl.textContent = 'Web NFC not supported on this browser/device. Use Chrome on Android.';
                return;
            }
            try {
                const reader = new NDEFReader();
                await reader.scan();
                statusEl.textContent = 'Scanning… bring the NFC tag near the phone.';

                reader.onreadingerror = () => {
                    statusEl.textContent = 'Read error, try again.';
                };
                reader.onreading = async (event) => {
                    statusEl.textContent = 'Tag read. Processing…';
                    let payload = null;

                    for (const record of event.message.records) {
                        try {
                            // Try URL record first
                            if (record.recordType === 'url') {
                                const url = new TextDecoder().decode(record.data);
                                payload = { type: 'url', value: url };
                                break;
                            }
                            // Fallback: text record possibly containing JSON or URL
                            if (record.recordType === 'text') {
                                const txt = new TextDecoder().decode(record.data);
                                payload = { type: txt.startsWith('http') ? 'url' : 'text', value: txt };
                                break;
                            }
                        } catch (e) {}
                    }

                    if (!payload) {
                        statusEl.textContent = 'No usable URL/text record found on tag.';
                        return;
                    }

                    try {
                        let transactionUrl;
                        if (payload.type === 'url' && payload.value.startsWith('http')) {
                            transactionUrl = payload.value; // Store the URL
                        } else {
                            statusEl.textContent = 'Unsupported payload format.';
                            return;
                        }
                        
                        // Redirect to bank transaction page with transaction data URL
                        window.location.href = `bank.html?data=${encodeURIComponent(transactionUrl)}`;
                    } catch (e) {
                        statusEl.textContent = 'Failed to load transaction URL.';
                        return;
                    }
                };
            } catch (err) {
                document.getElementById('status').textContent = 'NFC scan failed or permission denied.';
            }
        }

        document.getElementById('scanBtn').addEventListener('click', startScan);
    </script>
</body>
</html>
